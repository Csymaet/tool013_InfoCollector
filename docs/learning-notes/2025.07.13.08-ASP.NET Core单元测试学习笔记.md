# ASP.NET Core å•å…ƒæµ‹è¯•å­¦ä¹ ç¬”è®°

> å­¦ä¹ æ—¶é—´ï¼š2025å¹´7æœˆ13æ—¥  
> é¡¹ç›®ï¼šInfoCollectoræ¶ˆæ¯æ”¶é›†å·¥å…·  
> ä¸»é¢˜ï¼šASP.NET Core Web APIå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## ğŸ¯ å­¦ä¹ ç›®æ ‡

ç†è§£ä¸ºä»€ä¹ˆéœ€è¦æµ‹è¯•ï¼ŒæŒæ¡ASP.NET Coreé¡¹ç›®ä¸­å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•çš„è®¾è®¡ä¸å®ç°ã€‚

## ğŸ¤” ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•ï¼Ÿ

### æµ‹è¯•çš„é‡è¦æ€§

1. **ä¿è¯ä»£ç è´¨é‡**ï¼šç¡®ä¿åŠŸèƒ½æŒ‰é¢„æœŸå·¥ä½œ
2. **å›å½’æµ‹è¯•**ï¼šä¿®æ”¹ä»£ç åå¿«é€ŸéªŒè¯æ˜¯å¦ç ´åäº†ç°æœ‰åŠŸèƒ½
3. **æ–‡æ¡£ä½œç”¨**ï¼šæµ‹è¯•ç”¨ä¾‹å±•ç¤ºäº†ä»£ç çš„é¢„æœŸè¡Œä¸º
4. **é‡æ„ä¿¡å¿ƒ**ï¼šæœ‰æµ‹è¯•ä¿æŠ¤ï¼Œå¯ä»¥æ”¾å¿ƒåœ°é‡æ„ä»£ç 
5. **å›¢é˜Ÿåä½œ**ï¼šæ–°æˆå‘˜é€šè¿‡æµ‹è¯•äº†è§£ä»£ç è¡Œä¸º

### ä»€ä¹ˆæ—¶å€™å†™æµ‹è¯•ï¼Ÿ

- **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**ï¼šå¦‚æ•°æ®å­˜å‚¨ã€ä¸šåŠ¡è§„åˆ™éªŒè¯
- **APIç«¯ç‚¹**ï¼šç¡®ä¿HTTPæ¥å£æ­£ç¡®å“åº”
- **è¾¹ç•Œæ¡ä»¶**ï¼šç©ºå€¼ã€å¼‚å¸¸è¾“å…¥ç­‰ç‰¹æ®Šæƒ…å†µ
- **é‡è¦åŠŸèƒ½**ï¼šç”¨æˆ·æœ€å…³å¿ƒçš„åŠŸèƒ½

## ğŸ› ï¸ æµ‹è¯•é¡¹ç›®è®¾ç½®

### 1. åˆ›å»ºæµ‹è¯•é¡¹ç›®

```bash
# åˆ›å»ºxUnitæµ‹è¯•é¡¹ç›®
dotnet new xunit -n InfoCollectorAPI.Tests -o InfoCollectorAPI.Tests

# æ·»åŠ å¯¹ä¸»é¡¹ç›®çš„å¼•ç”¨
dotnet add InfoCollectorAPI.Tests/InfoCollectorAPI.Tests.csproj reference InfoCollectorAPI/InfoCollectorAPI.csproj
```

### 2. å®‰è£…å¿…è¦çš„æµ‹è¯•åŒ…

```bash
# ASP.NET Coreé›†æˆæµ‹è¯•
dotnet add package Microsoft.AspNetCore.Mvc.Testing

# å†…å­˜æ•°æ®åº“ï¼ˆç”¨äºæµ‹è¯•ï¼‰
dotnet add package Microsoft.EntityFrameworkCore.InMemory
```

### 3. é¡¹ç›®ç»“æ„

```
InfoCollectorAPI.Tests/
â”œâ”€â”€ InfoCollectorAPI.Tests.csproj    # æµ‹è¯•é¡¹ç›®æ–‡ä»¶
â”œâ”€â”€ MessageControllerTests.cs        # Controlleræµ‹è¯•
â”œâ”€â”€ IntegrationTests.cs              # é›†æˆæµ‹è¯•
â””â”€â”€ TestUtilities/                   # æµ‹è¯•å·¥å…·ç±»
    â””â”€â”€ TestDbContext.cs
```

## ğŸ“‹ æµ‹è¯•åŒ…è¯´æ˜

### æ ¸å¿ƒæµ‹è¯•åŒ…

| åŒ…å | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `xunit` | æµ‹è¯•æ¡†æ¶ | .NETç”Ÿæ€æœ€æµè¡Œçš„æµ‹è¯•æ¡†æ¶ |
| `xunit.runner.visualstudio` | æµ‹è¯•è¿è¡Œå™¨ | Visual Studio/VS Codeä¸­è¿è¡Œæµ‹è¯• |
| `Microsoft.NET.Test.Sdk` | æµ‹è¯•SDK | .NETæµ‹è¯•åŸºç¡€è®¾æ–½ |

### ASP.NET Coreä¸“ç”¨åŒ…

| åŒ…å | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| `Microsoft.AspNetCore.Mvc.Testing` | Web APIæµ‹è¯• | åˆ›å»ºæµ‹è¯•æœåŠ¡å™¨ï¼Œå‘é€HTTPè¯·æ±‚ |
| `Microsoft.EntityFrameworkCore.InMemory` | å†…å­˜æ•°æ®åº“ | æµ‹è¯•æ—¶ä½¿ç”¨å†…å­˜æ•°æ®åº“æ›¿ä»£çœŸå®æ•°æ®åº“ |

## ğŸ§ª å•å…ƒæµ‹è¯•è®¾è®¡

### æµ‹è¯•å‘½åè§„èŒƒ

```csharp
// æ ¼å¼ï¼šæ–¹æ³•å_æµ‹è¯•åœºæ™¯_é¢„æœŸç»“æœ
[Fact]
public async Task Post_ValidRequest_ReturnsOkResult()

[Fact] 
public async Task Post_NullRequest_ReturnsBadRequest()

[Fact]
public async Task Post_InvalidRequest_ReturnsBadRequest()
```

### AAAæ¨¡å¼ï¼ˆArrange-Act-Assertï¼‰

```csharp
[Fact]
public async Task Post_ValidRequest_SavesMessageToDatabase()
{
    // Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
    using var context = GetInMemoryDbContext();
    var controller = new MessageController(_logger, context);
    var request = new MessageRequest
    {
        GroupOrUserName = "æµ‹è¯•ç¾¤ç»„",
        MessageContent = "æµ‹è¯•æ¶ˆæ¯å†…å®¹", 
        ReceivedDateTime = DateTime.Now
    };

    // Act - æ‰§è¡Œè¦æµ‹è¯•çš„æ“ä½œ
    var result = await controller.Post(request);

    // Assert - éªŒè¯ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
    var okResult = Assert.IsType<OkObjectResult>(result);
    var savedMessage = await context.Messages.FirstOrDefaultAsync();
    Assert.NotNull(savedMessage);
    Assert.Equal("æµ‹è¯•ç¾¤ç»„", savedMessage.GroupOrUserName);
}
```

## ğŸ¯ æµ‹è¯•ç±»å‹è¯¦è§£

### 1. å•å…ƒæµ‹è¯•ï¼ˆUnit Testsï¼‰

**ç›®æ ‡**ï¼šæµ‹è¯•å•ä¸ªæ–¹æ³•æˆ–ç»„ä»¶çš„åŠŸèƒ½

```csharp
public class MessageControllerTests
{
    private readonly ILogger<MessageController> _logger;

    public MessageControllerTests()
    {
        _logger = new LoggerFactory().CreateLogger<MessageController>();
    }

    // åˆ›å»ºå†…å­˜æ•°æ®åº“ç”¨äºéš”ç¦»æµ‹è¯•
    private InfoCollectorDbContext GetInMemoryDbContext()
    {
        var options = new DbContextOptionsBuilder<InfoCollectorDbContext>()
            .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString())
            .Options;

        return new InfoCollectorDbContext(options);
    }

    [Fact]
    public async Task Post_ValidRequest_ReturnsOkResult()
    {
        // æµ‹è¯•æ­£å¸¸æƒ…å†µä¸‹çš„è¡Œä¸º
    }

    [Fact]
    public async Task Post_NullRequest_ReturnsBadRequest()
    {
        // æµ‹è¯•ç©ºè¯·æ±‚çš„å¤„ç†
    }
}
```

### 2. å‚æ•°åŒ–æµ‹è¯•ï¼ˆTheory Testsï¼‰

**ç›®æ ‡**ï¼šä½¿ç”¨ä¸åŒå‚æ•°æµ‹è¯•åŒä¸€ä¸ªé€»è¾‘

```csharp
[Theory]
[InlineData("", "æµ‹è¯•æ¶ˆæ¯")]           // ç©ºç¾¤å
[InlineData("æµ‹è¯•ç¾¤ç»„", "")]          // ç©ºæ¶ˆæ¯å†…å®¹
[InlineData(null, "æµ‹è¯•æ¶ˆæ¯")]        // nullç¾¤å
[InlineData("æµ‹è¯•ç¾¤ç»„", null)]        // nullæ¶ˆæ¯å†…å®¹
public async Task Post_InvalidRequest_ReturnsBadRequest(string groupOrUserName, string messageContent)
{
    // Arrange
    var request = new MessageRequest
    {
        GroupOrUserName = groupOrUserName,
        MessageContent = messageContent,
        ReceivedDateTime = DateTime.Now
    };

    // Act & Assert
    var result = await controller.Post(request);
    var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
    Assert.Equal("ç¾¤å/ç”¨æˆ·åå’Œæ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º", badRequestResult.Value);
}
```

### 3. é›†æˆæµ‹è¯•ï¼ˆIntegration Testsï¼‰

**ç›®æ ‡**ï¼šæµ‹è¯•å®Œæ•´çš„HTTPè¯·æ±‚-å“åº”æµç¨‹

```csharp
public class MessageControllerIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly WebApplicationFactory<Program> _factory;
    private readonly HttpClient _client;

    public MessageControllerIntegrationTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory;
        _client = _factory.CreateClient();
    }

    [Fact]
    public async Task PostMessage_ReturnsSuccessStatusCode()
    {
        // Arrange
        var request = new MessageRequest
        {
            GroupOrUserName = "é›†æˆæµ‹è¯•ç¾¤",
            MessageContent = "é›†æˆæµ‹è¯•æ¶ˆæ¯",
            ReceivedDateTime = DateTime.Now
        };
        
        var json = JsonSerializer.Serialize(request);
        var content = new StringContent(json, Encoding.UTF8, "application/json");

        // Act
        var response = await _client.PostAsync("/api/message", content);

        // Assert
        response.EnsureSuccessStatusCode();
        var responseString = await response.Content.ReadAsStringAsync();
        Assert.Contains("success", responseString);
    }
}
```

## ğŸ”§ æµ‹è¯•å·¥å…·å’ŒæŠ€å·§

### å†…å­˜æ•°æ®åº“çš„ä½¿ç”¨

```csharp
// ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹çš„å†…å­˜æ•°æ®åº“
private InfoCollectorDbContext GetInMemoryDbContext()
{
    var options = new DbContextOptionsBuilder<InfoCollectorDbContext>()
        .UseInMemoryDatabase(databaseName: Guid.NewGuid().ToString()) // å”¯ä¸€æ•°æ®åº“å
        .Options;

    return new InfoCollectorDbContext(options);
}
```

**ä¼˜ç‚¹**ï¼š
- æµ‹è¯•éš”ç¦»ï¼šæ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“
- é€Ÿåº¦å¿«ï¼šå†…å­˜æ“ä½œæ¯”ç£ç›˜IOå¿«
- æ— å‰¯ä½œç”¨ï¼šæµ‹è¯•ç»“æŸåæ•°æ®è‡ªåŠ¨æ¸…ç†

### æµ‹è¯•æ•°æ®æ„å»º

```csharp
// åˆ›å»ºæµ‹è¯•æ•°æ®çš„è¾…åŠ©æ–¹æ³•
private MessageRequest CreateValidMessageRequest(
    string groupName = "é»˜è®¤ç¾¤ç»„",
    string content = "é»˜è®¤æ¶ˆæ¯å†…å®¹")
{
    return new MessageRequest
    {
        GroupOrUserName = groupName,
        MessageContent = content,
        ReceivedDateTime = DateTime.Now
    };
}

// ä½¿ç”¨
var request = CreateValidMessageRequest("é¡¹ç›®è®¨è®ºç¾¤", "ä»Šå¤©å¼€ä¼š");
```

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### Controlleræµ‹è¯•è¦ç‚¹

1. **æˆåŠŸè·¯å¾„**ï¼šæ­£å¸¸è¾“å…¥ï¼Œè¿”å›é¢„æœŸç»“æœ
2. **éªŒè¯é€»è¾‘**ï¼šè¾“å…¥éªŒè¯ï¼Œè¾¹ç•Œæ¡ä»¶å¤„ç†
3. **é”™è¯¯å¤„ç†**ï¼šå¼‚å¸¸æƒ…å†µçš„å¤„ç†
4. **æ•°æ®æŒä¹…åŒ–**ï¼šç¡®ä¿æ•°æ®æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“

### å…·ä½“æµ‹è¯•æ¡ˆä¾‹

```csharp
// âœ… æ­£å¸¸æƒ…å†µæµ‹è¯•
[Fact] Post_ValidRequest_ReturnsOkResult()
[Fact] Post_ValidRequest_SavesMessageToDatabase() 

// âœ… è¾“å…¥éªŒè¯æµ‹è¯•
[Fact] Post_NullRequest_ReturnsBadRequest()
[Theory] Post_InvalidRequest_ReturnsBadRequest()

// âœ… ä¸šåŠ¡é€»è¾‘æµ‹è¯•  
[Fact] Post_MultipleRequests_SavesAllMessages()

// â³ å¼‚å¸¸å¤„ç†æµ‹è¯•ï¼ˆå¾…å®ç°ï¼‰
[Fact] Post_DatabaseError_ReturnsInternalServerError()
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### å‘½ä»¤è¡Œè¿è¡Œ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
dotnet test

# è¿è¡Œç‰¹å®šæµ‹è¯•é¡¹ç›®
dotnet test InfoCollectorAPI.Tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
dotnet test --filter "Post_ValidRequest_ReturnsOkResult"

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
dotnet test --verbosity normal

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
dotnet test --collect:"XPlat Code Coverage"
```

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```
æµ‹è¯•è¿è¡Œå¼€å§‹ï¼Œè¯·ç­‰å¾…...
æ€»å…±å‘ç°äº† 5 ä¸ªæµ‹è¯•æ–‡ä»¶
  é€šè¿‡!  - å¤±è´¥:     0, é€šè¿‡:     5, è·³è¿‡:     0, æ€»è®¡:     5
æµ‹è¯•è¿è¡ŒæˆåŠŸã€‚
æµ‹è¯•æ€»æ•°: 5
     é€šè¿‡: 5
 æŒç»­æ—¶é—´: 2.1 ç§’
```

## ğŸ“ˆ æµ‹è¯•æœ€ä½³å®è·µ

### 1. FIRSTåŸåˆ™

- **Fastï¼ˆå¿«é€Ÿï¼‰**ï¼šæµ‹è¯•åº”è¯¥å¿«é€Ÿè¿è¡Œ
- **Independentï¼ˆç‹¬ç«‹ï¼‰**ï¼šæµ‹è¯•ä¹‹é—´ä¸åº”ç›¸äº’ä¾èµ–
- **Repeatableï¼ˆå¯é‡å¤ï¼‰**ï¼šåœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½é‡å¤è¿è¡Œ
- **Self-Validatingï¼ˆè‡ªéªŒè¯ï¼‰**ï¼šæµ‹è¯•ç»“æœæ˜ç¡®ï¼ˆé€šè¿‡/å¤±è´¥ï¼‰
- **Timelyï¼ˆåŠæ—¶ï¼‰**ï¼šæµ‹è¯•åº”è¯¥åŠæ—¶ç¼–å†™

### 2. æµ‹è¯•æ•°æ®ç®¡ç†

```csharp
// âŒ ä¸å¥½çš„åšæ³•ï¼šç¡¬ç¼–ç æµ‹è¯•æ•°æ®
var request = new MessageRequest
{
    GroupOrUserName = "å…·ä½“çš„ç¾¤åç§°",
    MessageContent = "å…·ä½“çš„æ¶ˆæ¯å†…å®¹",
    ReceivedDateTime = new DateTime(2025, 7, 13, 10, 30, 0)
};

// âœ… æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨å·¥å‚æ–¹æ³•
var request = MessageRequestFactory.CreateValid();
var requestWithEmptyGroup = MessageRequestFactory.CreateWithEmptyGroup();
```

### 3. æ–­è¨€ç­–ç•¥

```csharp
// âŒ è¿‡äºå®½æ³›çš„æ–­è¨€
Assert.NotNull(result);

// âœ… å…·ä½“çš„æ–­è¨€
var okResult = Assert.IsType<OkObjectResult>(result);
var responseValue = Assert.IsAssignableFrom<object>(okResult.Value);

// âœ… ä¸šåŠ¡é€»è¾‘æ–­è¨€
Assert.Equal("æµ‹è¯•ç¾¤ç»„", savedMessage.GroupOrUserName);
Assert.True(savedMessage.Id > 0);
```

## ğŸ” ä¸‹ä¸€æ­¥å­¦ä¹ è®¡åˆ’

### ç«‹å³å¯ä»¥å®ç°
1. **å®ŒæˆMessageControllerå®Œæ•´æµ‹è¯•å¥—ä»¶**
2. **æ·»åŠ é›†æˆæµ‹è¯•**
3. **æµ‹è¯•å¼‚å¸¸å¤„ç†é€»è¾‘**

### è¿›é˜¶å­¦ä¹ 
1. **Mockæ¡†æ¶ä½¿ç”¨**ï¼ˆå¦‚Moqï¼‰
2. **æµ‹è¯•è¦†ç›–ç‡åˆ†æ**
3. **æ€§èƒ½æµ‹è¯•**
4. **è‡ªåŠ¨åŒ–æµ‹è¯•ç®¡é“**

## ğŸ’¡ å®é™…é¡¹ç›®ä»·å€¼

åœ¨InfoCollectoré¡¹ç›®ä¸­ï¼Œæµ‹è¯•å¸®åŠ©æˆ‘ä»¬ï¼š

1. **éªŒè¯APIæ­£ç¡®æ€§**ï¼šç¡®ä¿æ¶ˆæ¯èƒ½æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
2. **ä¿è¯æ•°æ®å®Œæ•´æ€§**ï¼šéªŒè¯æ‰€æœ‰å­—æ®µéƒ½è¢«æ­£ç¡®å­˜å‚¨
3. **è¾¹ç•Œæ¡ä»¶å¤„ç†**ï¼šç©ºå€¼ã€nullå€¼çš„æ­£ç¡®å¤„ç†
4. **å›å½’ä¿æŠ¤**ï¼šæœªæ¥ä¿®æ”¹ä»£ç æ—¶å¿«é€ŸéªŒè¯åŠŸèƒ½å®Œæ•´æ€§

## ğŸ¯ æ€»ç»“

å•å…ƒæµ‹è¯•ä¸æ˜¯"é¢å¤–å·¥ä½œ"ï¼Œè€Œæ˜¯**ä»£ç è´¨é‡çš„ä¿è¯**å’Œ**å¼€å‘æ•ˆç‡çš„æå‡**ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

- æ›´æœ‰ä¿¡å¿ƒåœ°ä¿®æ”¹å’Œæ‰©å±•ä»£ç 
- å¿«é€Ÿå‘ç°å’Œå®šä½é—®é¢˜
- ä¸ºå›¢é˜Ÿåä½œæä¾›è¡Œä¸ºæ–‡æ¡£
- ä¿è¯è½¯ä»¶çš„é•¿æœŸç¨³å®šæ€§

---

*è¿™ä»½ç¬”è®°è®°å½•äº†ä»æµ‹è¯•ç†å¿µåˆ°å®é™…å®ç°çš„å®Œæ•´å­¦ä¹ è¿‡ç¨‹ï¼Œä¸ºæ„å»ºé«˜è´¨é‡çš„ASP.NET Coreåº”ç”¨æ‰“ä¸‹äº†æµ‹è¯•åŸºç¡€ã€‚*