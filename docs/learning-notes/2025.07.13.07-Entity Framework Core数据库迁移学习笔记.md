# Entity Framework Core æ•°æ®åº“è¿ç§»å­¦ä¹ ç¬”è®°

> å­¦ä¹ æ—¶é—´ï¼š2025å¹´7æœˆ13æ—¥  
> é¡¹ç›®ï¼šInfoCollectoræ¶ˆæ¯æ”¶é›†å·¥å…·  
> ä¸»é¢˜ï¼šEntity Framework Coreæ•°æ®åº“è¿ç§»å®Œæ•´æµç¨‹

## ğŸ¯ å­¦ä¹ ç›®æ ‡

ç†è§£å¹¶æŒæ¡Entity Framework Coreä¸­æ•°æ®åº“è¿ç§»çš„æ¦‚å¿µã€ä½œç”¨å’Œå®Œæ•´æ“ä½œæµç¨‹ã€‚

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿ç§»ï¼Ÿ

**æ•°æ®åº“è¿ç§»(Migration)** æ˜¯å°†C#ä»£ç ä¸­å®šä¹‰çš„å®ä½“ç±»ç»“æ„è½¬æ¢ä¸ºå®é™…æ•°æ®åº“è¡¨ç»“æ„çš„è¿‡ç¨‹ã€‚

- **ä¸æ˜¯**ï¼šæŠŠç°æœ‰æ•°æ®ä»ä¸€ä¸ªåœ°æ–¹æ¬åˆ°å¦ä¸€ä¸ªåœ°æ–¹
- **è€Œæ˜¯**ï¼šæ ¹æ®ä»£ç æ¨¡å‹ç”Ÿæˆæ•°æ®åº“è¡¨ç»“æ„

### è¿ç§»çš„ä½œç”¨

1. **ä»£ç ä¼˜å…ˆ**ï¼šä»¥C#ç±»å®šä¹‰ä¸ºå‡†ï¼Œè‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“ç»“æ„
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šè·Ÿè¸ªæ•°æ®åº“ç»“æ„çš„å˜åŒ–å†å²
3. **å›¢é˜Ÿåä½œ**ï¼šç¡®ä¿æ‰€æœ‰å¼€å‘è€…çš„æ•°æ®åº“ç»“æ„ä¸€è‡´
4. **éƒ¨ç½²ç®¡ç†**ï¼šç”Ÿäº§ç¯å¢ƒå¯ä»¥å®‰å…¨åœ°æ›´æ–°æ•°æ®åº“ç»“æ„

## ğŸ› ï¸ å·¥å…·å®‰è£…

### å®‰è£…Entity Framework Coreå·¥å…·

```bash
# å®‰è£…å…¨å±€EFå·¥å…·
dotnet tool install --global dotnet-ef

# éªŒè¯å®‰è£…
dotnet ef --version
```

**è¯´æ˜**ï¼š
- `--global`ï¼šå…¨å±€å®‰è£…ï¼Œä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨
- å·¥å…·åç§°ï¼š`dotnet-ef`
- ç”¨é€”ï¼šæä¾›æ•°æ®åº“è¿ç§»ç›¸å…³å‘½ä»¤

## ğŸ“‚ é¡¹ç›®ç»“æ„å‡†å¤‡

### 1. åˆ›å»ºå®ä½“ç±»

```csharp
// Models/Message.cs
public class Message
{
    [Key]
    public int Id { get; set; }
    
    [Required]
    [MaxLength(500)]
    public string GroupOrUserName { get; set; } = string.Empty;
    
    [Required]
    public string MessageContent { get; set; } = string.Empty;
    
    [Required]
    public DateTime ReceivedDateTime { get; set; }
}
```

### 2. åˆ›å»ºDbContext

```csharp
// Data/InfoCollectorDbContext.cs
public class InfoCollectorDbContext : DbContext
{
    public InfoCollectorDbContext(DbContextOptions<InfoCollectorDbContext> options) : base(options)
    {
    }

    public DbSet<Message> Messages { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // é…ç½®å®ä½“å’Œç´¢å¼•
        modelBuilder.Entity<Message>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Id).ValueGeneratedOnAdd();
            
            entity.HasIndex(e => e.ReceivedDateTime)
                .HasDatabaseName("IX_Messages_ReceivedDateTime");
                
            entity.HasIndex(e => e.GroupOrUserName)
                .HasDatabaseName("IX_Messages_GroupOrUserName");
        });
    }
}
```

### 3. é…ç½®æ•°æ®åº“è¿æ¥

```json
// appsettings.json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=database/InfoCollector.db"
  }
}
```

```csharp
// Program.cs
builder.Services.AddDbContext<InfoCollectorDbContext>(options =>
    options.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection")));
```

## ğŸ”„ è¿ç§»æ“ä½œæµç¨‹

### æ­¥éª¤1ï¼šåˆ›å»ºè¿ç§»

```bash
dotnet ef migrations add InitialCreate
```

**å‘½ä»¤è¯´æ˜**ï¼š
- `migrations add`ï¼šåˆ›å»ºæ–°çš„è¿ç§»
- `InitialCreate`ï¼šè¿ç§»åç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- ç”Ÿæˆæ–‡ä»¶ï¼š
  - `Migrations/[æ—¶é—´æˆ³]_InitialCreate.cs`ï¼šè¿ç§»æ–‡ä»¶
  - `Migrations/[æ—¶é—´æˆ³]_InitialCreate.Designer.cs`ï¼šè®¾è®¡å™¨æ–‡ä»¶
  - `Migrations/InfoCollectorDbContextModelSnapshot.cs`ï¼šæ¨¡å‹å¿«ç…§

### æ­¥éª¤2ï¼šæŸ¥çœ‹è¿ç§»æ–‡ä»¶å†…å®¹

ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶åŒ…å«ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼š

```csharp
public partial class InitialCreate : Migration
{
    // åˆ›å»ºæ•°æ®åº“ç»“æ„
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.CreateTable(
            name: "Messages",
            columns: table => new
            {
                Id = table.Column<int>(type: "INTEGER", nullable: false)
                    .Annotation("Sqlite:Autoincrement", true),
                GroupOrUserName = table.Column<string>(type: "TEXT", maxLength: 500, nullable: false),
                MessageContent = table.Column<string>(type: "TEXT", nullable: false),
                ReceivedDateTime = table.Column<DateTime>(type: "TEXT", nullable: false)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_Messages", x => x.Id);
            });

        // åˆ›å»ºç´¢å¼•
        migrationBuilder.CreateIndex(
            name: "IX_Messages_GroupOrUserName",
            table: "Messages",
            column: "GroupOrUserName");

        migrationBuilder.CreateIndex(
            name: "IX_Messages_ReceivedDateTime",
            table: "Messages",
            column: "ReceivedDateTime");
    }

    // å›æ»šæ•°æ®åº“ç»“æ„
    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropTable(name: "Messages");
    }
}
```

### æ­¥éª¤3ï¼šåº”ç”¨è¿ç§»

```bash
dotnet ef database update
```

**å‘½ä»¤è¯´æ˜**ï¼š
- `database update`ï¼šå°†è¿ç§»åº”ç”¨åˆ°æ•°æ®åº“
- æ‰§è¡Œæ“ä½œï¼š
  - åˆ›å»ºæ•°æ®åº“æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  - æ‰§è¡Œè¿ç§»æ–‡ä»¶ä¸­çš„`Up()`æ–¹æ³•
  - åˆ›å»ºè¡¨å’Œç´¢å¼•
  - è®°å½•è¿ç§»å†å²åˆ°`__EFMigrationsHistory`è¡¨

### æ‰§è¡Œæ—¥å¿—è§£æ

```bash
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE TABLE "Messages" (
          "Id" INTEGER NOT NULL CONSTRAINT "PK_Messages" PRIMARY KEY AUTOINCREMENT,
          "GroupOrUserName" TEXT NOT NULL,
          "MessageContent" TEXT NOT NULL,
          "ReceivedDateTime" TEXT NOT NULL
      );
```

è¿™è¡¨æ˜EFæˆåŠŸæ‰§è¡Œäº†SQLå‘½ä»¤åˆ›å»ºäº†Messagesè¡¨ã€‚

## ğŸ“‹ å¸¸ç”¨EF Coreå‘½ä»¤

### è¿ç§»ç®¡ç†å‘½ä»¤

```bash
# åˆ›å»ºæ–°è¿ç§»
dotnet ef migrations add [è¿ç§»åç§°]

# åˆ é™¤æœ€æ–°è¿ç§»ï¼ˆæœªåº”ç”¨åˆ°æ•°æ®åº“çš„ï¼‰
dotnet ef migrations remove

# æŸ¥çœ‹è¿ç§»åˆ—è¡¨
dotnet ef migrations list

# ç”ŸæˆSQLè„šæœ¬ï¼ˆä¸æ‰§è¡Œï¼‰
dotnet ef migrations script

# åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“
dotnet ef database update

# å›æ»šåˆ°æŒ‡å®šè¿ç§»
dotnet ef database update [è¿ç§»åç§°]

# åˆ é™¤æ•°æ®åº“
dotnet ef database drop
```

### ä¿¡æ¯æŸ¥è¯¢å‘½ä»¤

```bash
# æŸ¥çœ‹EFå·¥å…·ç‰ˆæœ¬
dotnet ef --version

# æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯
dotnet ef dbcontext info

# æŸ¥çœ‹DbContextåˆ—è¡¨
dotnet ef dbcontext list

# ç”ŸæˆDbContextè„šæ‰‹æ¶ï¼ˆä»ç°æœ‰æ•°æ®åº“ï¼‰
dotnet ef dbcontext scaffold [è¿æ¥å­—ç¬¦ä¸²] [æä¾›ç¨‹åº]
```

## ğŸ—ï¸ é¡¹ç›®ç»“æ„å˜åŒ–

### è¿ç§»å‰
```
InfoCollectorAPI/
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Message.cs
â”‚   â””â”€â”€ MessageRequest.cs
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ InfoCollectorDbContext.cs
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ MessageController.cs
â””â”€â”€ database/           # ç©ºæ–‡ä»¶å¤¹
```

### è¿ç§»å
```
InfoCollectorAPI/
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Message.cs
â”‚   â””â”€â”€ MessageRequest.cs
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ InfoCollectorDbContext.cs
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ MessageController.cs
â”œâ”€â”€ Migrations/         # æ–°å¢ï¼šè¿ç§»æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ 20250713180026_InitialCreate.cs
â”‚   â”œâ”€â”€ 20250713180026_InitialCreate.Designer.cs
â”‚   â””â”€â”€ InfoCollectorDbContextModelSnapshot.cs
â””â”€â”€ database/
    â””â”€â”€ InfoCollector.db    # æ–°å¢ï¼šå®é™…æ•°æ®åº“æ–‡ä»¶
```

## ğŸ¯ å®é™…åº”ç”¨æ•ˆæœ

### æ•°æ®åº“è¡¨ç»“æ„

æ‰§è¡Œè¿ç§»åï¼ŒSQLiteæ•°æ®åº“ä¸­åˆ›å»ºäº†ä»¥ä¸‹ç»“æ„ï¼š

```sql
-- ä¸»è¡¨
CREATE TABLE "Messages" (
    "Id" INTEGER NOT NULL CONSTRAINT "PK_Messages" PRIMARY KEY AUTOINCREMENT,
    "GroupOrUserName" TEXT NOT NULL,
    "MessageContent" TEXT NOT NULL,
    "ReceivedDateTime" TEXT NOT NULL
);

-- ç´¢å¼•
CREATE INDEX "IX_Messages_GroupOrUserName" ON "Messages" ("GroupOrUserName");
CREATE INDEX "IX_Messages_ReceivedDateTime" ON "Messages" ("ReceivedDateTime");

-- EFç®¡ç†è¡¨
CREATE TABLE "__EFMigrationsHistory" (
    "MigrationId" TEXT NOT NULL CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY,
    "ProductVersion" TEXT NOT NULL
);
```

### Controllerä¸­çš„æ•°æ®åº“æ“ä½œ

```csharp
[HttpPost]
public async Task<IActionResult> Post([FromBody] MessageRequest request)
{
    var message = new Message
    {
        GroupOrUserName = request.GroupOrUserName,
        MessageContent = request.MessageContent,
        ReceivedDateTime = request.ReceivedDateTime
    };

    _context.Messages.Add(message);
    await _context.SaveChangesAsync();

    return Ok(new { 
        success = true, 
        messageId = message.Id,
        message = "æ¶ˆæ¯ä¿å­˜æˆåŠŸ" 
    });
}
```

## ğŸ” æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

### 1. è¿ç§»å‘½åè§„èŒƒ
- ä½¿ç”¨æè¿°æ€§åç§°ï¼š`AddUserTable`ã€`UpdateMessageIndex`
- é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦å’Œä¸­æ–‡

### 2. æ•°æ®åº“æ–‡ä»¶ä½ç½®
- å¼€å‘ç¯å¢ƒï¼šç›¸å¯¹è·¯å¾„ `database/InfoCollector.db`
- ç”Ÿäº§ç¯å¢ƒï¼šå»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„
- å¤‡ä»½ç­–ç•¥ï¼šå®šæœŸå¤‡ä»½SQLiteæ–‡ä»¶

### 3. è¿ç§»å®‰å…¨æ€§
- åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨è¿ç§»å‰å…ˆæµ‹è¯•
- é‡è¦æ•°æ®å¤‡ä»½åå†æ‰§è¡Œè¿ç§»
- äº†è§£å›æ»šæ“ä½œï¼š`dotnet ef database update [ä¹‹å‰çš„è¿ç§»å]`

### 4. å›¢é˜Ÿåä½œ
- è¿ç§»æ–‡ä»¶éœ€è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- å›¢é˜Ÿæˆå‘˜éœ€è¦æ‰§è¡Œ `dotnet ef database update` åŒæ­¥æ•°æ®åº“
- é¿å…å¤šäººåŒæ—¶åˆ›å»ºè¿ç§»

## ğŸ“ˆ å­¦ä¹ æ”¶è·

1. **ç†è§£äº†è¿ç§»çš„æœ¬è´¨**ï¼šä»£ç ç»“æ„ â†’ SQLè„šæœ¬ â†’ æ•°æ®åº“è¡¨
2. **æŒæ¡äº†å®Œæ•´æµç¨‹**ï¼šè®¾è®¡å®ä½“ â†’ åˆ›å»ºè¿ç§» â†’ åº”ç”¨è¿ç§»
3. **å­¦ä¼šäº†å®ç”¨å‘½ä»¤**ï¼šåˆ›å»ºã€æŸ¥çœ‹ã€åº”ç”¨ã€å›æ»šè¿ç§»
4. **å®ç°äº†æ•°æ®æŒä¹…åŒ–**ï¼šAPIæ•°æ®å¯ä»¥æ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

1. æµ‹è¯•å®Œæ•´çš„APIåŠŸèƒ½
2. å­¦ä¹ æ›´å¤æ‚çš„è¿ç§»åœºæ™¯ï¼ˆä¿®æ”¹è¡¨ç»“æ„ï¼‰
3. äº†è§£æ•°æ®åº“æŸ¥è¯¢å’Œä¼˜åŒ–
4. é›†æˆåˆ°å®é™…çš„Taskerå·¥ä½œæµä¸­

---

*è¿™ä»½ç¬”è®°è®°å½•äº†ä»é›¶å¼€å§‹å­¦ä¹ Entity Framework Coreæ•°æ®åº“è¿ç§»çš„å®Œæ•´è¿‡ç¨‹ï¼Œä¸ºåç»­çš„æ•°æ®åº“æ“ä½œæ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚*